"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const multer = require("multer");
const chitcore_1 = require("chitcore");
const upload = multer();
const router = express_1.Router();
router.post("/login", upload.none(), function (req, res, next) {
    var _a;
    if ((_a = req.session.user) === null || _a === void 0 ? void 0 : _a.loggedIn) {
        next();
        return;
    }
    if (req.body.user === "admin" && req.body.pwd === "admin") {
        req.session.user = {
            loggedIn: true,
            name: "admin"
        };
        res.status(200).json("LOGGED_IN");
    }
    else {
        res.status(401).json("LOGIN_FAILED");
    }
});
router.use(function auth(req, res, next) {
    var _a;
    if ((_a = req.session.user) === null || _a === void 0 ? void 0 : _a.loggedIn) {
        next();
        return;
    }
    res.status(401).render("error", { code: 401, title: "Forbidden!", message: "You are not allowed here." });
});
router.get("/login", (req, res, next) => res.status(200).json("LOGGED_IN"));
router.get("/logout", function (req, res, next) {
    req.session.destroy((err) => {
        if (err)
            throw err;
        res.status(200).json("LOGGED_OUT");
    });
});
let isPostgress = (process.env.DATABASE_URL) ? true : false;
const pgOptions = { type: "postgres", url: process.env.DATABASE_URL };
if (((_a = process.env) === null || _a === void 0 ? void 0 : _a.DISABLE_PG_SSL) !== "true") {
    pgOptions.ssl = { rejectUnauthorized: false };
}
const pgdbmgmt = new chitcore_1.Dbmgmt(pgOptions);
let pgconnected = false;
let connectedUsers = 0;
async function pgconnect() {
    if (!pgconnected) {
        await pgdbmgmt.connect();
        pgconnected = true;
    }
    connectedUsers++;
    return;
}
async function pgclose() {
    if (pgconnected && connectedUsers <= 1) {
        await pgdbmgmt.close();
        pgconnected = false;
    }
    connectedUsers--;
    return;
}
router.ws("/dbmgmt", async function (ws, req) {
    // Ping Timer
    const pingInt = setInterval(() => {
        try {
            ws.ping();
        }
        catch (e) {
            console.log(e);
        }
    }, 5000);
    const user = req.session.user.name;
    let dbmgmt;
    // Opening connection
    if (isPostgress) {
        dbmgmt = pgdbmgmt;
        await pgconnect();
    }
    else {
        dbmgmt = new chitcore_1.Dbmgmt({ type: "sqlite", database: "./db/" + user + ".db" });
        await dbmgmt.connect();
    }
    // Binding listeners
    ws.on("message", async (data) => {
        if (typeof data !== "string")
            return;
        let args = JSON.parse(data);
        let response = await dbmgmt.runQuery(args);
        ws.send(JSON.stringify({ queryId: args.queryId, reply: response }));
    });
    // Closing connection
    ws.on("close", async (code) => {
        clearInterval(pingInt);
        if (isPostgress) {
            await pgclose();
        }
        else {
            await dbmgmt.close();
        }
    });
});
router.use((req, res, next) => next());
exports.default = router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3JvdXRlcy9hcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQWlDO0FBQ2pDLGlDQUFpQztBQUNqQyx1Q0FBa0M7QUFDbEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFDeEIsTUFBTSxNQUFNLEdBQUcsZ0JBQU0sRUFBRSxDQUFDO0FBRXhCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxVQUFVLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSTs7SUFDM0QsVUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksMENBQUUsUUFBUSxFQUFFO1FBQzlCLElBQUksRUFBRSxDQUFDO1FBQ1AsT0FBTztLQUNSO0lBRUQsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxPQUFPLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssT0FBTyxFQUFFO1FBQ3pELEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHO1lBQ2pCLFFBQVEsRUFBRSxJQUFJO1lBQ2QsSUFBSSxFQUFFLE9BQU87U0FDZCxDQUFDO1FBQ0YsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7S0FDbkM7U0FBTTtRQUNMLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0tBQ3RDO0FBRUgsQ0FBQyxDQUFDLENBQUM7QUFDSCxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSTs7SUFDckMsVUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksMENBQUUsUUFBUSxFQUFFO1FBQzlCLElBQUksRUFBRSxDQUFDO1FBQ1AsT0FBTztLQUNSO0lB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